<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8"/>
    <style>
        body {
            font-family: "Microsoft YaHei","黑体",'Segoe UI', Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        table {
            border-collapse: collapse;
        }

            table th, table td {
                padding: 2px 6px;
            }

            table td {
                text-align: right;
            }

        .loading td {
            text-align: left;
        }

        .phoneLink {
            cursor: pointer;
            color: cornflowerblue;
        }

            .phoneLink:hover {
                color: blue;
            }

        .highlight {
            color: deeppink;
        }

        .lowlight {
            color: #c5006a;
        }

        a:visited, a {
            color:navy
        }
    </style>
</head>
<body>
<div>
    平仓收益榜（只能从公司IP访问）
</div>
<br/>
    当前时间范围：<label id="lblDays"></label>天&nbsp;&nbsp;&nbsp;
    <input id="txtDays" type="hidden" value="14" />
    <input type="button" value="2 weeks" onclick="document.getElementById('txtDays').value = '14'; loadData();" />
    <input type="button" value="All Time" onclick="document.getElementById('txtDays').value = '9999'; loadData();"/>
    <input id="txtUserId" type="hidden" value="" />
    <br/>
    <br />
<div id="rankTable">
    <table border="1" style="white-space: nowrap">
        <thead>
        <tr>
            <!--<th>ID</th>-->
            <th>头像</th>
            <th>昵称</th>
            <th>收益率</th>
            <th>胜率</th>
            <th>平仓数</th>
            <th>净收益</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr class="loading"><td colspan="8">loading...</td></tr>
        </tbody>
    </table>
</div>

    <div id="positionTable" style="display: none">
        <table border="1" style="white-space: nowrap">
            <thead>
                <tr>
                    <th>产品</th>
                    <th>涨跌</th>
                    <th>本金</th>
                    <th>杠杆</th>
                    <th>开仓时间↓</th>
                    <th>开仓价</th>
                    <th>收益</th>
                    <th>收益率</th>
                    <th>平仓时间</th>
                    <th>平仓价</th>
                </tr>
            </thead>
            <tbody>
                <tr class="loading"><td colspan="6">loading...</td></tr>
            </tbody>
        </table>
    </div>

<script src="/Scripts/jquery-1.6.4.min.js"></script>
<script type="text/javascript">
    function getQueryStringByName(name) {
        var result = location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
        if (result == null || result.length < 1) {
            return "";
        }
        return result[1];
    }

    // A simple templating method for replacing placeholders enclosed in curly braces.
    if (!String.prototype.supplant) {
        String.prototype.supplant = function(o) {
            return this.replace(/{([^{}]*)}/g,
                function(a, b) {
                    //debugger;
                    var r = o[b];
                    //return typeof r === 'string' || typeof r === 'number' ? r : a;
                    if (b == 'picUrl') {
                        if (r == null)
                            r = '';
                        //else
                            return '<img src="' + r + '" style="width:30px;height:30px" />';
                    }

                    if (b == 'roi') {
                        if(r>=0)
                            return '<font style="color:#f4415f">' + (Math.round(r * 10000) / 100).toFixed(2) + '%</font>';
                        else
                            return '<font style="color:#32c17a">' + (Math.round(r * 10000) / 100).toFixed(2) + '%</font>';
                    }

                    if (b == 'winRate')
                        return (Math.round(r * 10000) / 100).toFixed(2) + '%';

                    //if (b == 'posCount')
                    //    return '<a href="#" onclick="showPositions('+o.id+');return false;">'+r+'</a>';

                    if (b == 'pl') {
                        if (r >= 0)
                            return '<font style="color:#f4415f; font-weight:' + Math.floor((r + 100 > 900 ? 900 : r + 100) / 100) + '00">' + r.toFixed(2) + '</font>';
                        else
                            return '<font style="color:#32c17a; font-weight:' + Math.floor((-r + 100 > 900 ? 900 : -r + 100) / 100) + '00">' + r.toFixed(2) + '</font>';
                    }

                    if (b == 'closeAt' && r == '0001-01-01T00:00:00')
                        return '';

                    if (b == 'openAt' || b == 'closeAt') {
                        var dt = new Date(r);
                        dt.setTime(dt.getTime() + (8 * 60 * 60 * 1000));
                        return dt.toLocaleString();
                    }

                    if (b == 'closePrice' && r == 0)
                        return '';

                    if (b == 'security.name')
                        return o.security.name;

                    if (b == 'isLong') {
                        if (r)
                            return '↗';
                        else
                            return '↘';
                    }

                    //debugger;

                    return r;
                }
            );
        };
    }

    function loadData() {
        var div = document.getElementById('positionTable');
        div.style.display = 'none';

        document.getElementById('lblDays').innerText = document.getElementById('txtDays').value;
        var url = 'api/rank/live/user/plClosed?day=' + document.getElementById('txtDays').value;

        $.ajax(url).done(function (datas) {
            $rankTableBody.empty();
            $.each(datas, function () {
                var data = formatData(this);
                $rankTableBody.append(rankRowTemplate.supplant(data) //.replace('{Shortable}', stock.Shortable)
                );
            });
        });

        //url = 'api/competition/1/position';

        //$.ajax(url).done(function (datas) {
        //    $positionTableBody.empty();
        //    $.each(datas, function () {
        //        var data = formatData(this);
        //        $positionTableBody.append(positionRowTemplate.supplant(data)//.replace('{Side}', data.Side)
        //        );
        //    });
        //});
    }

    function loadPosData() {
        var userId = document.getElementById('txtUserId').value;

        var url = 'api/position/live/report?userId=' + userId;

        $.ajax(url).done(function (datas) {
            $positionTableBody.empty();
            $.each(datas, function () {
                var data = formatPositionData(this);
                $positionTableBody.append(positionRowTemplate.supplant(data) //.replace('{Shortable}', stock.Shortable)
                );
            });
        });
    }


        var ticker =
                $rankTable = $('#rankTable'),
            $rankTableBody = $rankTable.find('tbody'),
            rankRowTemplate = '<tr data-symbol="{id}">' 
                //+'<td>{id}</td>'
            +'<td>{picUrl}</td><td>{nickname}</td><td>{roi}</td><td>{winRate}</td><td>{posCount}</td><td>{pl}</td>'
            +'<td><a href="#" onclick="showPositions(this,{id});return false;">明细</a></td>'
                //+ '<td>{Bid}</td><td>{Offer}</td>'
                //+ '<td>{LastOpen}</td><td>{LastClose}</td><td>{PreClose}</td><td>{OpenBid}</td><td>{OpenAsk}</td><td>{CloseBid}</td><td>{CloseAsk}</td>'
                //+ '<td>{MaxLeverage}</td><td>{Shortable}</td><td>{MinSizeShort}</td><td>{MaxSizeShort}</td><td>{MinSizeLong}</td><td>{MaxSizeLong}</td>'
                + '</tr>',

        $positionTable = $('#positionTable'),
        $positionTableBody = $positionTable.find('tbody'),
        positionRowTemplate = '<tr data-symbol="{id}"><td>{security.name}</td><td>{isLong}</td><td>{invest}</td><td>{leverage}</td><td>{openAt}</td><td>{openPrice}</td>'
        + '<td>{pl}</td><td>{roi}</td>'
        + '<td>{closeAt}</td><td>{closePrice}</td>'
        //+ '<td>{MaxLeverage}</td><td>{Shortable}</td><td>{MinSizeShort}</td><td>{MaxSizeShort}</td><td>{MinSizeLong}</td><td>{MaxSizeLong}</td>'
        + '</tr>';

        function formatData(data) {
            //return $.extend(stock, {
            //    Offer: stock.Offer.toFixed(2),
            //    PercentChange: (stock.last*1.03 * 100).toFixed(2) + '%',
            //    Direction: stock.Change === 0 ? '' : stock.Change >= 0 ? up : down
            //});
            return data;
        }

        function formatPositionData(data) {
            //return $.extend(stock, {
            //    Offer: stock.Offer.toFixed(2),
            //    PercentChange: (stock.last*1.03 * 100).toFixed(2) + '%',
            //    Direction: stock.Change === 0 ? '' : stock.Change >= 0 ? up : down
            //});
            data.roi = data.pl / data.invest;
            return data;
        }

        $(loadData());

        function showPositions(obj, id) {
            $('a').each(function() { this.style.fontWeight = ''; });

            obj.style.fontWeight = 'bold';

            var div = document.getElementById('positionTable');

            div.style.display = '';
            div.style.position = 'absolute';

            var base = $(obj).parent();
            //debugger;

            $(div).offset({
                left: base.offset().left + base.outerWidth() + 5,
                top: base.offset().top //+ base.height()
            });

            document.getElementById('txtUserId').value = id;
            loadPosData();
        }
  
</script>

</body>
</html>
